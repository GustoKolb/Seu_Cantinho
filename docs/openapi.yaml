openapi: 3.0.3

info:
  title: Sistema de Reservas - Backend API
  version: 1.0.0
  description: |
    API do backend que gerencia Locais, Reservas e Usuários.
    Todas as respostas são encapsuladas em um objeto JSON padrão (Apresentado aqui como ServerResponse) para indicar sucesso ou falha, dados retornados e uma mensagem explicando o resultado interno.

    A API utilizada encapsula os códigos de resposta HTTP, portanto, é utilizado também um valor de simplificação interno, seguindo o mapeamento HTTP (exit_code) a seguir:
      - 200/201 (0): Sucesso no processamento
      - 400 (1): Erro de validação, parâmetro inválido, ID não encontrado (CRUD),
                 ou conflito de regra de negócio (Datas/Login)
      - 404 (-1): Endpoint inválido
      - 500 (2): Erro interno (e.g. falha ao ler/gravar DB)

    Essa documentação é referente aos endpoints do broker e sua funcionalidade, porém, como o broker simplesmente redireciona as requisições recebidas para o servidor, a documentação é análoga (no protótipo foram utilizados os nomes traduzidos para demonstrar o funcionamento do redirecionamento: /usuarios -> /users).

servers:
  - url: /
    description: URL base do Broker

tags:
  - name: Usuários
    description: Gerenciamento de usuários e autenticação.
  - name: Locais
    description: Gerenciamento de locais disponíveis para locação.
  - name: Reservas
    description: Gerenciamento de reservas e verificação de conflito de datas.

paths:
  /login:
    post:
      tags: [Usuários]
      summary: Autenticação de Usuário
      description: Realiza o login. Se válido, retorna status de administrador.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginCredentials'
      responses:
        '200':
          description: Informações Processadas Com Sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponseBoolean'

  /usuarios:
    get:
      tags: [Usuários]
      summary: Busca Usuários com possibilidade de filtros
      parameters:
        - name: byId
          in: query
          schema: { type: integer }
        - name: byName
          in: query
          schema: { type: string }
        - name: byPassword
          in: query
          schema: { type: string }
      responses:
        '200':
          description: Lista de usuários
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponseArrayUser'

    post:
      tags: [Usuários]
      summary: Cria um Novo Usuário
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        '201':
          description: Usuário criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponse'

  /usuarios/{id}:
    patch:
      tags: [Usuários]
      summary: Atualiza Informações de um Usuário
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserInput'
      responses:
        '200': { description: Usuário atualizado }
        '400': { description: Usuário não encontrado }


    delete:
      tags: [Usuários]
      summary: Deleta um Usuário
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Usuário Deletado }
        '400': { description: Usuário não encontrado }

  /locais:
    get:
      tags: [Locais]
      summary: Busca Locais com possibilidade de filtros
      parameters:
        - { name: byId,         in: query, schema: { type: integer } }
        - { name: byName,       in: query, schema: { type: string } }
        - { name: byCountry,    in: query, schema: { type: string } }
        - { name: byPriceMin,   in: query, schema: { type: number, format: float } }
        - { name: byCapacityMin,in: query, schema: { type: integer } }
        - { name: byState,      in: query, schema: { type: string } }
        - { name: byCity,       in: query, schema: { type: string } }
        - { name: byDistrict,   in: query, schema: { type: string } }
        - { name: byPriceMax,   in: query, schema: { type: number, format: float } }
        - { name: byCapacityMax,in: query, schema: { type: integer } }
      responses:
        '200':
          description: Lista de locais
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponseArrayPlace'
        '500':
          description: Erro ao Ler banco de dados
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponse'

    post:
      tags: [Locais]
      summary: Cria um Novo Local
      description: Upload opcional de imagem principal via Base64.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlaceInput'
      responses:
        '201':
          description: Local criado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponse'
        '500':
          description: Erro ao atualizar banco de dados
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponse'

  /locais/{id}:
    patch:
      tags: [Locais]
      summary: Atualiza Informações de um Local
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlaceInput'
      responses:
        '200': { description: Local atualizado }
        '400': { description: Local não encontrado }

    delete:
      tags: [Locais]
      summary: Deleta um Local
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Local deletado }
        '400': { description: Local não encontrado }

  /reservas:
    get:
      tags: [Reservas]
      summary: Lista e Filtra Reservas
      parameters:
        - { name: byId,          in: query, schema: { type: integer } }
        - { name: byClientName,  in: query, schema: { type: string } }
        - { name: byPlaceId,     in: query, schema: { type: integer } }
      responses:
        '200':
          description: Lista de reservas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponseArrayBooking'

    post:
      tags: [Reservas]
      summary: Cria uma Nova Reserva
      description: Cria Uma nova reserva com verificação de conflito de data/local.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BookingInput'
      responses:
        '201':
          description: Reserva criada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponse'
        '400':
          description: Conflito de data ou parâmetro inválido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponse'

  /reservas/{id}:
    patch:
      tags: [Reservas]
      summary: Atualiza uma Reserva
      description: Valida conflitos com outras reservas.
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BookingInput'
      responses:
        '200': { description: Reserva atualizada }
        '400': { description: Reserva não encontrada ou conflito }

    delete:
      tags: [Reservas]
      summary: Deleta uma Reserva
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        '200': { description: Reserva deletada }
        '400': { description: Reserva não encontrada }

  /images/{filename}:
    get:
      tags: [Locais]
      summary: Retorna Imagem em Base64
      description: Retorna a imagem de um Local em Base64 para renderização. Para o protótipo implementado pode parecer estranho, mas pensando numa melhoria onde existem diversas imagens por lugar, esse endpoint separado permite carregar de forma otimizada imagens especificas - visto que cada local tem uma lista de {filename}s - como por exemplo renderizar somente a primeira imagem da lista para utilizar de capa no catálogo.
      parameters:
        - name: filename
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Imagem codificada em Base64
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponseBase64'
        '400':
          description: Arquivo não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerResponse'

components:
  schemas:
    ServerResponse:
      type: object
      properties:
        ok:   { type: boolean }
        msg:  { type: string }
        data: { type: object, nullable: true }

    ServerResponseArrayUser:
      allOf:
        - $ref: '#/components/schemas/ServerResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/User'

    ServerResponseArrayPlace:
      allOf:
        - $ref: '#/components/schemas/ServerResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Place'

    ServerResponseArrayBooking:
      allOf:
        - $ref: '#/components/schemas/ServerResponse'
        - type: object
          properties:
            data:
              type: array
              items:
                $ref: '#/components/schemas/Booking'

    ServerResponseBase64:
      allOf:
        - $ref: '#/components/schemas/ServerResponse'
        - type: object
          properties:
            data: { type: string }

    ServerResponseBoolean:
      allOf:
        - $ref: '#/components/schemas/ServerResponse'
        - type: object
          properties:
            data: { type: boolean }

    LoginCredentials:
      type: object
      required: [user, password]
      properties:
        user:     { type: string }
        password: { type: string }

    UserInput:
      type: object
      required: [name, filial_id, isAdmin, password]
      properties:
        name:      { type: string }
        filial_id: { type: integer }
        isAdmin:   { type: boolean }
        password:  { type: string }

    User:
      allOf:
        - $ref: '#/components/schemas/UserInput'
        - type: object
          required: [id]
          properties:
            id: { type: integer }

    PlaceBase:
      type: object
      required: [name, country, state, city, district, street, number, description, capacity, price]
      properties:
        name:        { type: string }
        country:     { type: string }
        state:       { type: string }
        city:        { type: string }
        district:    { type: string }
        street:      { type: string }
        number:      { type: string }
        description: { type: string }
        capacity:    { type: integer }
        price:       { type: number, format: float }

    PlaceInput:
      allOf:
        - $ref: '#/components/schemas/PlaceBase'
        - type: object
          properties:
            image_b64: { type: string }

    Place:
      allOf:
        - $ref: '#/components/schemas/PlaceBase'
        - type: object
          required: [id, images]
          properties:
            id: { type: integer }
            images:
              type: array
              items: { type: string }

    BookingBase:
      type: object
      required: [client_name, client_email, client_phone, amount_paid, total_amount, start_date, end_date]
      properties:
        client_name:  { type: string }
        client_email: { type: string }
        client_phone: { type: string }
        amount_paid:  { type: number, format: float }
        total_amount: { type: number, format: float }
        start_date:   { type: string, format: date }
        end_date:     { type: string, format: date }

    BookingInput:
      allOf:
        - $ref: '#/components/schemas/BookingBase'
        - type: object
          required: [place_id]
          properties:
            place_id: { type: integer }

    Booking:
      allOf:
        - $ref: '#/components/schemas/BookingBase'
        - type: object
          required: [id, place]
          properties:
            id: { type: integer }
            place:
              $ref: '#/components/schemas/Place'
