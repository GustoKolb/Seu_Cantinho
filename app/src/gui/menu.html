<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seu Cantinho - Menu</title>
</head>

<body style="margin:0;">
    <iframe src="topBar.html" style="width:100%;height:60px;border:none;margin:0;" scrolling="no"></iframe>

    <div id="menu" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(5rem, 18rem)); gap:1rem; padding:1rem; text-wrap: nowrap;"></div>

    <script src="config.js"></script>
    <script src="topBar.js"></script>
    <script>
        const menu = document.getElementById("menu");
        start_menu()
        
        async function start_menu(){
            const query = new URLSearchParams(location.search).toString()
            if (location.search)
                history.replaceState(null, "", location.origin+location.pathname)

            const locais = await window.fetchPlaces(query)

            if (!locais){
                document.getElementById('menu').innerText = "Erro Ao Se Comunicar Com O Servidor"
                return
            }
            if (!locais.length){
                document.getElementById('menu').innerText = "Nenhum local encontrado"
                return;
            }

            load_menu(locais, menu)
        }

        window.onTopbarSearch = async function(filters){
            const locais = await window.fetchPlaces(filters);
            const menu = document.getElementById("menu");
            menu.innerHTML = "";

            if (!locais || locais.length === 0) {
                menu.innerText = "Nenhum local encontrado";
                return;
            }

            load_menu(locais, menu);
        };

        function load_menu(locais, menu){
            menu.innerHTML = "";
            for (const local of locais) {
                const bloco = document.createElement("div");
                bloco.style.flex = "0 0 200px";
                bloco.style.border = "1px solid #ccc";
                bloco.style.borderRadius = "10px";
                bloco.style.padding = "10px";
                bloco.style.textAlign = "left";
                bloco.style.textWrap = "wrap";
                bloco.style.background = "white";
                bloco.style.cursor = "pointer";

                const img = document.createElement("img");
                fetch(`${window.CONFIG.BROKER_URL}/${window.CONFIG.ENDPOINT_IMAGENS}/${local.images[0]}`).then(r => r.json()).then(j => {
                    img.src = "data:image/jpeg;base64," + j.data;
                });
                img.style.width = "100%";
                img.style.borderRadius = "5px";
                bloco.appendChild(img);

                const nome = document.createElement("div");
                nome.innerText = local.name;
                nome.style.margin = "10px auto";
                bloco.appendChild(nome);

                const preco = document.createElement("div");
                preco.innerText = '$' + local.price;
                bloco.appendChild(preco);

                const info = document.createElement("div");
                info.innerHTML = `<b>Local</b>: ${local.country} - ${local.state} - ${local.city}<br><b>Capacidade</b>: ${local.capacity}`;
                info.style.fontSize = "0.8rem";
                bloco.appendChild(info);

                bloco.onclick = () => {window.location.href = `local.html?id=${local.id}`;};
                menu.appendChild(bloco);
            }
        }
    </script>
</body>

</html>
        
